<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Browser Compatibility -->
  <meta name="format-detection" content="telephone=no">
  <meta name="msapplication-tap-highlight" content="no">
  
  {% comment %} SEO Meta Tags {% endcomment %}
  {% assign current_lang = page.lang | default: site.default_lang | default: 'zh' %}
  {% capture site_title %}{% include translate.html key='site.title' %}{% endcapture %}
  {% capture page_title_local %}
    {% if page.seo and page.seo.title %}
      {{ page.seo.title }}
    {% elsif page.title_key %}
      {% include translate.html key=page.title_key %}
    {% elsif page.title %}
      {{ page.title | strip_html | strip }}
    {% endif %}
  {% endcapture %}
  {% assign formatted_title = site_title | strip %}
  {% if page_title_local | strip != '' %}
    {% assign formatted_title = page_title_local | strip | append: ' | ' | append: formatted_title %}
  {% endif %}
  <title>{{ formatted_title }}</title>

  {% capture site_description %}{% include translate.html key='site.description' %}{% endcapture %}
  {% capture page_description %}
    {% if page.description_key %}
      {% include translate.html key=page.description_key %}
    {% elsif page.seo and page.seo.description %}
      {{ page.seo.description }}
    {% elsif page.description %}
      {{ page.description }}
    {% elsif page.excerpt %}
      {{ page.excerpt | strip_html }}
    {% else %}
      {{ site_description }}
    {% endif %}
  {% endcapture %}
  {% assign sanitized_description = page_description | strip_html | strip | replace: '\n', ' ' | replace: '  ', ' ' %}
  <meta name="description" content="{{ sanitized_description }}">

  {% assign keyword_list = nil %}
  {% if page.keywords %}
    {% assign keyword_list = page.keywords %}
  {% elsif page.seo and page.seo.keywords %}
    {% assign keyword_list = page.seo.keywords %}
  {% elsif current_lang == 'zh' %}
    {% capture default_keywords %}{% include translate.html key='site.keywords' %}{% endcapture %}
    {% if page.title_key %}
      {% capture page_keywords %}{% include translate.html key=page.title_key %}{% endcapture %}
      {% assign keyword_list = default_keywords | append: ',' | append: page_keywords | split: ',' %}
    {% else %}
      {% assign keyword_list = default_keywords | split: ',' %}
    {% endif %}
  {% endif %}
  {% if keyword_list %}
    <meta name="keywords" content="{{ keyword_list | join: ', ' }}">
  {% endif %}

  {% if page.noindex %}
    <meta name="robots" content="noindex, nofollow">
  {% elsif page.nofollow %}
    <meta name="robots" content="index, nofollow">
  {% elsif page.robots %}
    <meta name="robots" content="{{ page.robots }}">
  {% endif %}

  {% assign page_path = page.url | default: '/' %}
  {% if page.canonical_url %}
    {% assign canonical_url = page.canonical_url %}
  {% elsif page_path contains '://' %}
    {% assign canonical_url = page_path %}
  {% elsif site.url and site.url != '' %}
    {% assign canonical_url = site.url | append: site.baseurl | append: page_path %}
  {% else %}
    {% assign canonical_url = site.baseurl | append: page_path %}
  {% endif %}
  <link rel="canonical" href="{{ canonical_url }}">

  <!-- RSS Feed Links -->
  {% if current_lang == "zh" %}
    <link rel="alternate" type="application/atom+xml" title="{{ site.title }} - Chinese Feed" href="{{ site.url }}{{ site.baseurl }}/feed.xml" />
  {% else %}
    <link rel="alternate" type="application/atom+xml" title="{{ site.title }} - English Feed" href="{{ site.url }}{{ site.baseurl }}/feed_en.xml" />
  {% endif %}

  {% assign og_type = 'website' %}
  {% if page.layout == 'post' or page.collection == 'posts' %}
    {% assign og_type = 'article' %}
  {% endif %}
  {% assign raw_seo_image = page.og_image | default: page.image | default: site.seo.default_image | default: '/assets/img/logo.svg' %}
  {% if raw_seo_image contains '://' %}
    {% assign seo_image = raw_seo_image %}
  {% else %}
    {% assign seo_image = site.url | append: site.baseurl | append: raw_seo_image %}
  {% endif %}
  {% assign seo_image_alt = page.seo.image_alt | default: page.image_alt | default: formatted_title %}
  {% assign og_locale = 'zh-CN' %}
  {% if current_lang == 'en' %}
    {% assign og_locale = 'en-NZ' %}
  {% endif %}

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="{{ og_type }}">
  <meta property="og:url" content="{{ canonical_url }}">
  <meta property="og:title" content="{{ formatted_title }}">
  <meta property="og:description" content="{{ sanitized_description }}">
  <meta property="og:image" content="{{ seo_image }}">
  <meta property="og:image:alt" content="{{ seo_image_alt }}">
  <meta property="og:locale" content="{{ og_locale }}">
  {% if site.social and site.social.links %}
    {% for social_url in site.social.links %}
      <meta property="og:see_also" content="{{ social_url }}">
    {% endfor %}
  {% endif %}
  {% if page.layout == 'post' %}
    {% if page.author %}
      <meta property="article:author" content="{{ page.author }}">
    {% endif %}
    {% if page.categories %}
      {% for category in page.categories %}
        <meta property="article:section" content="{{ category | replace: '-', ' ' | capitalize }}">
      {% endfor %}
    {% endif %}
    {% if page.tags %}
      {% for tag in page.tags %}
        <meta property="article:tag" content="{{ tag }}">
      {% endfor %}
    {% endif %}
    <meta property="article:published_time" content="{{ page.date | date_to_xmlschema }}">
    {% if page.modified_date %}
      <meta property="article:modified_time" content="{{ page.modified_date | date_to_xmlschema }}">
    {% endif %}
  {% endif %}

  <!-- Twitter (Phase 2: conditional - only on key pages, otherwise fallback to OG) -->
  {% if page.url == "/" or page.url == "/en/" or page.url contains "/services" or page.url contains "/about" or page.url contains "/team" %}
  {% assign twitter_card = 'summary_large_image' %}
  {% if page.seo and page.seo.twitter_card %}
    {% assign twitter_card = page.seo.twitter_card %}
  {% endif %}
  <meta property="twitter:card" content="{{ twitter_card }}">
  <meta property="twitter:image" content="{{ seo_image }}">
  {% if site.twitter and site.twitter.username %}
    <meta property="twitter:site" content="@{{ site.twitter.username | replace: '@', '' }}">
  {% endif %}
  {% else %}
  <!-- Twitter falls back to Open Graph tags for other pages -->
  <meta property="twitter:card" content="summary_large_image">
  {% endif %}
  
  <!-- Hreflang tags for bilingual SEO -->
  {% if current_lang == "zh" %}
    {% comment %}Self-referencing hreflang for Chinese page{% endcomment %}
    <link rel="alternate" hreflang="zh-CN" href="{{ site.url }}{{ site.baseurl }}{{ page.url }}" />
    {% comment %}Only add English hreflang for pages, not blog posts since blog posts don't have English versions{% endcomment %}
    {% unless page.url contains '/blog/' and page.url != '/blog/' %}
      <link rel="alternate" hreflang="en-NZ" href="{{ site.url }}{{ site.baseurl }}/en{{ page.url }}" />
    {% endunless %}
    <link rel="alternate" hreflang="x-default" href="{{ site.url }}{{ site.baseurl }}{{ page.url }}" />
  {% else %}
    {% comment %}Self-referencing hreflang for English page{% endcomment %}
    <link rel="alternate" hreflang="en-NZ" href="{{ site.url }}{{ site.baseurl }}{{ page.url }}" />
    {% comment %}Only add Chinese hreflang if not an individual English blog post{% endcomment %}
    {% if page.url contains '/en/blog/' and page.url != '/en/blog/' %}
      {% comment %}For English blog posts without Chinese versions, point to Chinese blog index{% endcomment %}
      <link rel="alternate" hreflang="zh-CN" href="{{ site.url }}{{ site.baseurl }}/blog/" />
      <link rel="alternate" hreflang="x-default" href="{{ site.url }}{{ site.baseurl }}/blog/" />
    {% else %}
      {% comment %}For regular English pages, assume Chinese version exists{% endcomment %}
      <link rel="alternate" hreflang="zh-CN" href="{{ site.url }}{{ site.baseurl }}{{ page.url | replace: '/en', '' }}" />
      <link rel="alternate" hreflang="x-default" href="{{ site.url }}{{ site.baseurl }}{{ page.url | replace: '/en', '' }}" />
    {% endif %}
  {% endif %}
  
  <!-- Preconnect to external domains for better performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://rsms.me">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://unpkg.com">
  
  <!-- Optimized font loading (Phase 2: reduced from 15 to 8 weights) -->
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"></noscript>
  
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;500;600&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;500;600&display=swap"></noscript>
  
  <!-- Accent font (minimal weight for testimonials) -->
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400&display=swap"></noscript>
  
  <!-- Deferred JavaScript loading -->
  <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js" defer></script>
  {% if jekyll.environment == "production" %}
  <script src="{{ '/assets/js/wechat-modal.min.js' | relative_url }}" defer></script>
  {% else %}
  <script src="{{ '/assets/js/wechat-modal.js' | relative_url }}" defer></script>
  {% endif %}
  {% if jekyll.environment == "production" %}
  <link rel="stylesheet" href="{{ '/assets/css/style.min.css' | relative_url }}">
  {% else %}
  <link rel="stylesheet" href="{{ '/assets/css/style.css' | relative_url }}">
  {% endif %}
  <link
    rel="stylesheet"
    href="{{ '/assets/vendor/@fortawesome/fontawesome-free/css/all.min.css' | relative_url }}"
  />
  <script src="https://unpkg.com/phosphor-icons" defer></script>
  
  <!-- Note: Accessibility and Hero section styles moved to assets/css/style.css for better caching -->
  
  {%- feed_meta -%}
  
  <!-- Consolidated Structured Data for SEO (Phase 1: working version) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@graph": [
      {
        "@type": ["InsuranceAgency", "Organization"],
        "@id": "{{ site.url }}{{ site.baseurl }}/#organization",
        "name": "{% include translate.html key='site.company_name' %}",
        "alternateName": ["Cornerstone Insurance Limited", "新西兰华人保险顾问", "奥克兰华人保险顾问"],
        "description": "{% include translate.html key='site.description' %}",
        "url": "{{ site.url }}{{ site.baseurl }}",
        "knowsLanguage": ["zh-CN", "en-NZ"],
        "logo": {
          "@type": "ImageObject",
          "url": "{{ site.url }}{{ site.baseurl }}/assets/img/logo.svg"
        },
        "image": "{{ site.url }}{{ site.baseurl }}/assets/img/logo.svg",
        "telephone": "+64211280727",
        "email": "amy.tao@cornerstonefs.co.nz",
        "contactPoint": {
          "@type": "ContactPoint",
          "telephone": "{{ site.data[current_lang].site.phone }}",
          "contactType": "customer service",
          "areaServed": "NZ"
        },
        "address": {
          "@type": "PostalAddress",
          "streetAddress": "80B Forrest Hill Road",
          "addressLocality": "Forrest Hill",
          "addressRegion": "Auckland",
          "postalCode": "0620",
          "addressCountry": "NZ"
        },
        "areaServed": {
          "@type": "Country",
          "name": "New Zealand"
        }{% if page.url == "/" or page.layout == "home" %},
        "hasOfferCatalog": {
          "@type": "OfferCatalog",
          "name": "Insurance Services",
          "itemListElement": [
            {
              "@type": "Offer",
              "itemOffered": {
                "@type": "Service",
                "name": "Life Insurance",
                "description": "Comprehensive life insurance coverage to protect your family's financial future"
              }
            },
            {
              "@type": "Offer",
              "itemOffered": {
                "@type": "Service",
                "name": "Health Insurance",
                "description": "Private health insurance for faster access to medical treatment"
              }
            },
            {
              "@type": "Offer",
              "itemOffered": {
                "@type": "Service",
                "name": "Income Protection",
                "description": "Financial security when you're unable to work due to illness or injury"
              }
            }
          ]
        }{% endif %}
      },
      {
        "@type": "WebSite",
        "@id": "{{ site.url }}{{ site.baseurl }}/#website",
        "url": "{{ site.url }}{{ site.baseurl }}",
        "name": "{{ site_title | strip }}",
        "publisher": {
          "@id": "{{ site.url }}{{ site.baseurl }}/#organization"
        },
        "potentialAction": {
          "@type": "SearchAction",
          "target": "{{ site.url }}{{ site.baseurl }}/search?q={search_term_string}",
          "query-input": "required name=search_term_string"
        }
      }{% if page.schema_type and page.schema_data %},
      {{ page.schema_data | jsonify }}{% endif %}
    ]
  }
  </script>
  
  {%- include custom-head.html -%}

</head>
